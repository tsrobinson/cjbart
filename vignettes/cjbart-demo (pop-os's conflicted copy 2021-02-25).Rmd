---
title: "Heterogeneous effects analysis of conjoint experiments"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Heterogeneous effects analysis of conjoint experiments}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

set.seed(89)
```

This vignette provides a brief example of how to estimate heterogeneous effects in conjoint experiments, using \code{cjbart}.

Suppose we conducted a conjoint experiment on 500 individuals, where each individual makes 5 discrete choices between two profiles. The resultant data would include 5000 observations. Within this conjoint, suppose there are five attributes A-E, each with 3 levels. We also record two covariates of each subject. Let's mock up this data:

```{r data, include=TRUE}
subjects <- 500
rounds <- 5
profiles <- 2
obs <- subjects*rounds*profiles

fake_data <- data.frame(id1 = rep(1:subjects, each=rounds*profiles),
                        Y = c(1,0),
                        A = sample(c("a1","a2","a3"), obs, replace = TRUE),
                        B = sample(c("b1","b2","b3"), obs, replace = TRUE),
                        C = sample(c("c1","c2","c3"), obs, replace = TRUE),
                        D = sample(c("d1","d2","d3"), obs, replace = TRUE),
                        E = sample(c("e1","e2","e3"), obs, replace = TRUE),
                        covar1 = rep(runif(subjects, 0 ,100), 
                                     each = rounds*profiles),
                        covar2 = rep(sample(c(1,0), subjects, 
                                            replace = TRUE), 
                                     each = rounds*profiles),
                        stringsAsFactors = TRUE)
```

## Train a probit BART model on conjoint data

To estimate a conjoint model on this data we will use the `cjbart()` function, which uses Bayesian Additive Regression Trees (BART) to approximate the relationships between the outcome (a binary choice), the randomised attribute-levels, and the included covariates. The result is a `pbart` model, which we will use to estimate heterogeneity in the treatment effects:

```{r train, include=TRUE}
library(cjbart)
cj_model <- cjbart(data = fake_data,
                   Y_var = "Y", 
                   id_var = "id1")

```

To generate heterogeneity estimates at the observation- and individual-level, we use the `OMCE()` function. We pass in both the original experimental data, and the conjoint model generated in the last step. At this point, we also declare the names of the conjoint attribute variables (`attribs`) and the reference category we want to use for each attribute when calculating the marginal component effects (`ref_levels`). The vector of reference levels must be of the same length as `attribs`, with the level at position `i` corresponding to the `attrib[i]`:

```{r OMCE, include=TRUE}
het_effects <- cjbart::OMCE(data = fake_data, 
                            model = cj_model, 
                            attribs = c("A","B","C","D","E"),
                            ref_levels = c("a1","b1","c1","d1","e1"),
                            Y_var = "Y", 
                            id_var = "id1", 
                            cores = 8)
```

`OMCE()` returns an object of class "cjbart", which is a list with three objects: `omce` estimates, `imce` estimates, and a vector of attribute levels (used when plotting the results).

It is likely that users will want to compare the conjoint estimation strategy to other estimation strategies, such as logistic regression models. We can recover the average marginal component effect (AMCE) for the BART model using the `summary()` command:

````{r summary}
summary(het_effects)
```

We find that the derived AMCES are consistent with parametric calculation of the AMCEs, using estimating packages like `cregg`:

```{r cregg}

cregg_amce <- cregg::cj(fake_data, Y ~ A + B + C + D + E, id = ~ id1)
cjbart_amce <- summary(het_effects)

colnames(cjbart_amce)[1] <- "level"



merge(cregg_amce[,c("level","estimate")], cjbart_amce[,c("level","AMCE")])

```

`cjbart` also contains a plotting function to visualise heterogeneity in the data.

## Immigration (Hainmueller et al 2014)

```{r immigration}
library(cregg)
data("immigration")
immigration$LangPos <- NULL
immigration$PriorPos <- NULL
immigration$profile <- NULL
immigration$contest_no <- NULL

immig_model <- cjbart(data = immigration,
                   Y_var = "ChosenImmigrant", 
                   id_var = "CaseID")

immig_attribs <- c("Education","Gender","CountryOfOrigin",
                   "ReasonForApplication","Job","JobExperience",
                   "JobPlans","PriorEntry","LanguageSkills")

immig_refs <- sapply(immig_attribs, function (x) levels(immigration[[x]])[1])

immig_het <- cjbart::OMCE(data = immigration, 
                            model = immig_model, 
                            attribs = immig_attribs,
                            ref_levels = immig_refs,
                            Y_var = "ChosenImmigrant", 
                            id_var = "CaseID", 
                            cores = 8)


```




